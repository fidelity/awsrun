<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>awsrun.cache API documentation</title>
<meta name="description" content="Provides the ability to cache single values â€¦" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css" rel="stylesheet">
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<!-- <link href="/awsrun/webfonts.css" rel="stylesheet"> -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Roboto:ital,wght@0,300;0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<style>
body {
font-size: 16px;
font-family: 'Roboto', sans-serif;
}
code {
font-family: 'Roboto Mono', monospace;
}
#content {
max-width: 100ch;
}
/* `Text` size and code in main body text */
section code {
font-size: 14px;
}
/* Line height for blocks of code in main text */
pre code {
font-size: 13px;
line-height: 1.35em;
}
/* "expand source code" text */
details {
font-size: 12px;
}
/* Code block in the expand source section */
.source pre code {
font-size: 12px;
line-height: 1.35em;
}
/* Navbar code */
ul li code a {
font-size: 14px;
}
/* Used in method names sections etc .. */
code.name {
font-size: 14px;
}
.title code {
font-family: 'Roboto', sans-serif;
}
dt {
font-weight: bold;
}
h1 {
font-size: 2.0em;
}
</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>awsrun.cache</code></h1>
</header>
<section id="section-intro">
<p>Provides the ability to cache single values.</p>
<h2 id="overview">Overview</h2>
<p>The module provides the <code><a title="awsrun.cache.AbstractExpiringValue" href="#awsrun.cache.AbstractExpiringValue">AbstractExpiringValue</a></code> abstract base class, which is
responsible for the lazy loading of a value that is cached for a finite amount
of time. The base class provides the core functionality that depends on the
subclass's implementation of <code>is_expired</code>, <code>load</code>, and <code>save</code>.</p>
<p>Two concrete implementations are provided in this module. The first,
<code><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></code>, caches the value in memory, while the second,
<code><a title="awsrun.cache.PersistentExpiringValue" href="#awsrun.cache.PersistentExpiringValue">PersistentExpiringValue</a></code> caches the value to disk as JSON. The following
example demonstrates how to use this <code><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></code>:</p>
<pre><code>&gt;&gt;&gt; import time
&gt;&gt;&gt; ev = ExpiringValue(refresh_fn=time.ctime, max_age=10)
&gt;&gt;&gt; ev.value(); time.sleep(5); ev.value(); time.sleep(5); ev.value()
'Sat Jul 13 15:04:30 2019'
'Sat Jul 13 15:04:30 2019'
'Sat Jul 13 15:04:40 2019'
</code></pre>
<p>The first two timestamps are the same because <code>value</code> was 5 seconds apart, which
is before the value would have expired, and thus the cached result is returned.
The third value, however, is ten seconds later because by the time the third
invocation of <code>value</code> took place, the original value expired after 10 seconds.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#
# Copyright 2019 FMR LLC &lt;opensource@fidelity.com&gt;
#
# SPDX-License-Identifier: MIT
#
&#34;&#34;&#34;Provides the ability to cache single values.

## Overview

The module provides the `AbstractExpiringValue` abstract base class, which is
responsible for the lazy loading of a value that is cached for a finite amount
of time. The base class provides the core functionality that depends on the
subclass&#39;s implementation of `is_expired`, `load`, and `save`.

Two concrete implementations are provided in this module. The first,
`ExpiringValue`, caches the value in memory, while the second,
`PersistentExpiringValue` caches the value to disk as JSON. The following
example demonstrates how to use this `ExpiringValue`:

    &gt;&gt;&gt; import time
    &gt;&gt;&gt; ev = ExpiringValue(refresh_fn=time.ctime, max_age=10)
    &gt;&gt;&gt; ev.value(); time.sleep(5); ev.value(); time.sleep(5); ev.value()
    &#39;Sat Jul 13 15:04:30 2019&#39;
    &#39;Sat Jul 13 15:04:30 2019&#39;
    &#39;Sat Jul 13 15:04:40 2019&#39;

The first two timestamps are the same because `value` was 5 seconds apart, which
is before the value would have expired, and thus the cached result is returned.
The third value, however, is ten seconds later because by the time the third
invocation of `value` took place, the original value expired after 10 seconds.
&#34;&#34;&#34;

import json
import logging
import threading
import time
from pathlib import Path

LOG = logging.getLogger(__name__)


class AbstractExpiringValue:
    &#34;&#34;&#34;Abstract base class to represent a value that expires.

    An `AbstractExpiringValue` represents a lazily loaded value that will expire
    over time. The constructor takes a `refresh_fn` function of zero arguments,
    which is called to obtain the value to be cached for `max_age` seconds.

    At the time of instantiation, the value is not retrieved, it is only
    retrieved the first time the value method is invoked. Likewise, the value is
    not refreshed at the time it expires, but only the next time the value
    method is called. This class is thread-safe. Subclasses must provide
    implementations for `is_expired`, `load`, and `save`.
    &#34;&#34;&#34;

    def __init__(self, refresh_fn, max_age):
        self._refresh_fn = refresh_fn
        self._max_age = max_age
        self._lock = threading.Lock()

    def value(self, refresh=False):
        &#34;&#34;&#34;Returns the value.

        The first time this method is called, the value will be obtained by
        calling the `refresh_fn` supplied in the constructor. Subsequent
        invocations of this method will return the cached value until it
        expires. If you set `refresh` parameter to `True`, the value will be
        refreshed and the expiration will be reset before being returned.
        &#34;&#34;&#34;
        with self._lock:
            if not refresh and not self.is_expired():
                return self.load()

            value = self._refresh_fn()
            self.save(value)
            LOG.info(&#34;refreshed data and saved in cache&#34;)
            return value

    def is_expired(self):
        &#34;&#34;&#34;Returns `True` if the value needs to be refreshed, `False` otherwise.

        If this returns `True` during the invocation of
        `AbstractExpiringValue.value`, the `refresh_fn` will be called, followed
        by `save`, to renew the cached value. When this returns `False`, `load`
        is invoked instead to return the value from the cache.
        &#34;&#34;&#34;
        raise NotImplementedError

    def load(self):
        &#34;&#34;&#34;Returns the value from the cache.

        If `is_expired` returns `False` during the invocation of
        `AbstractExpiringValue.value`, this method is invoked to return the
        value from the cache.
        &#34;&#34;&#34;
        raise NotImplementedError

    def save(self, value):
        &#34;&#34;&#34;Saves the value to the cache.

        If `is_expired` returns `True` during the invocation of
        `AbstractExpiringValue.value`, this method is invoked to save the new
        value to the cache.
        &#34;&#34;&#34;
        raise NotImplementedError


class ExpiringValue(AbstractExpiringValue):
    &#34;&#34;&#34;Represents a lazily loaded value that will expire over time.

    An `ExpiringValue` represents a lazily loaded value that will expire over
    time and is cached in memory. The constructor takes a `refresh_fn` function
    of zero arguments, which is called to obtain the value to be cached for
    `max_age` seconds.

    At the time of instantiation, the value is not retrieved, it is only
    retrieved the first time the value method is invoked. Likewise, the value is
    not refreshed at the time it expires, but only the next time the value
    method is called. This class is thread-safe.
    &#34;&#34;&#34;

    def __init__(self, refresh_fn, max_age):
        super().__init__(refresh_fn, max_age)
        self._value = None
        self._expiry = 0

    def is_expired(self):
        return time.time() &gt;= self._expiry

    def load(self):
        LOG.debug(&#34;Loading data from cache&#34;)
        return self._value

    def save(self, value):
        LOG.debug(&#34;Saving value to cache&#34;)
        self._value = value
        self._expiry = time.time() + self._max_age


class PersistentExpiringValue(ExpiringValue):
    &#34;&#34;&#34;Represents an expiring value that will be persisted to disk as JSON.

    A `PersistentExpiringValue` represents a lazily loaded value that will
    expire over time and is cached to disk as JSON. The constructor takes a
    `refresh_fn` function of zero arguments, which is called to obtain the value
    to be cached for `max_age` seconds to the file specified by the `path` --
    either a string or a `pathlib.Path` object.

    At the time of instantiation, the value is not retrieved, it is only
    retrieved the first time the value method is invoked. Likewise, the value is
    not refreshed at the time it expires, but only the next time the value
    method is called. This class is thread-safe. If the value cannot be
    persisted as JSON, a TypeError is thrown.
    &#34;&#34;&#34;

    def __init__(self, refresh_fn, path, max_age):
        super().__init__(refresh_fn, max_age)
        self._path = path if isinstance(path, Path) else Path(path)

    def is_expired(self):
        if not self._path.exists():
            return True
        last_modification = self._path.stat().st_mtime
        return time.time() &gt; last_modification + self._max_age

    def load(self):
        LOG.debug(&#34;Loading cached data from %s&#34;, self._path)
        with self._path.open(&#34;r&#34;, encoding=&#34;utf-8&#34;) as file:
            return json.load(file)

    def save(self, value):
        # No need to persist the file if max_age is 0 seconds.
        if self._max_age == 0:
            return

        LOG.debug(&#34;Saving data to cache file %s&#34;, self._path)
        tmp = self._path.with_suffix(&#34;.tmp&#34;)
        with tmp.open(&#34;w&#34;, encoding=&#34;utf-8&#34;) as file:
            json.dump(value, file)

        # Pathlib.replace uses os.replace which is atomic on POSIX systems
        tmp.replace(self._path)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="awsrun.cache.AbstractExpiringValue"><code class="flex name class">
<span>class <span class="ident">AbstractExpiringValue</span></span>
<span>(</span><span>refresh_fn, max_age)</span>
</code></dt>
<dd>
<section class="desc"><p>Abstract base class to represent a value that expires.</p>
<p>An <code><a title="awsrun.cache.AbstractExpiringValue" href="#awsrun.cache.AbstractExpiringValue">AbstractExpiringValue</a></code> represents a lazily loaded value that will expire
over time. The constructor takes a <code>refresh_fn</code> function of zero arguments,
which is called to obtain the value to be cached for <code>max_age</code> seconds.</p>
<p>At the time of instantiation, the value is not retrieved, it is only
retrieved the first time the value method is invoked. Likewise, the value is
not refreshed at the time it expires, but only the next time the value
method is called. This class is thread-safe. Subclasses must provide
implementations for <code>is_expired</code>, <code>load</code>, and <code>save</code>.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class AbstractExpiringValue:
    &#34;&#34;&#34;Abstract base class to represent a value that expires.

    An `AbstractExpiringValue` represents a lazily loaded value that will expire
    over time. The constructor takes a `refresh_fn` function of zero arguments,
    which is called to obtain the value to be cached for `max_age` seconds.

    At the time of instantiation, the value is not retrieved, it is only
    retrieved the first time the value method is invoked. Likewise, the value is
    not refreshed at the time it expires, but only the next time the value
    method is called. This class is thread-safe. Subclasses must provide
    implementations for `is_expired`, `load`, and `save`.
    &#34;&#34;&#34;

    def __init__(self, refresh_fn, max_age):
        self._refresh_fn = refresh_fn
        self._max_age = max_age
        self._lock = threading.Lock()

    def value(self, refresh=False):
        &#34;&#34;&#34;Returns the value.

        The first time this method is called, the value will be obtained by
        calling the `refresh_fn` supplied in the constructor. Subsequent
        invocations of this method will return the cached value until it
        expires. If you set `refresh` parameter to `True`, the value will be
        refreshed and the expiration will be reset before being returned.
        &#34;&#34;&#34;
        with self._lock:
            if not refresh and not self.is_expired():
                return self.load()

            value = self._refresh_fn()
            self.save(value)
            LOG.info(&#34;refreshed data and saved in cache&#34;)
            return value

    def is_expired(self):
        &#34;&#34;&#34;Returns `True` if the value needs to be refreshed, `False` otherwise.

        If this returns `True` during the invocation of
        `AbstractExpiringValue.value`, the `refresh_fn` will be called, followed
        by `save`, to renew the cached value. When this returns `False`, `load`
        is invoked instead to return the value from the cache.
        &#34;&#34;&#34;
        raise NotImplementedError

    def load(self):
        &#34;&#34;&#34;Returns the value from the cache.

        If `is_expired` returns `False` during the invocation of
        `AbstractExpiringValue.value`, this method is invoked to return the
        value from the cache.
        &#34;&#34;&#34;
        raise NotImplementedError

    def save(self, value):
        &#34;&#34;&#34;Saves the value to the cache.

        If `is_expired` returns `True` during the invocation of
        `AbstractExpiringValue.value`, this method is invoked to save the new
        value to the cache.
        &#34;&#34;&#34;
        raise NotImplementedError</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<code><li><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></li></code>
</ul>
<h3>Methods</h3>
<dl>
<dt id="awsrun.cache.AbstractExpiringValue.value"><code class="name flex">
<span>def <span class="ident">value</span></span>(<span>self, refresh=False)</span>
</code></dt>
<dd>
<section class="desc"><p>Returns the value.</p>
<p>The first time this method is called, the value will be obtained by
calling the <code>refresh_fn</code> supplied in the constructor. Subsequent
invocations of this method will return the cached value until it
expires. If you set <code>refresh</code> parameter to <code>True</code>, the value will be
refreshed and the expiration will be reset before being returned.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def value(self, refresh=False):
    &#34;&#34;&#34;Returns the value.

    The first time this method is called, the value will be obtained by
    calling the `refresh_fn` supplied in the constructor. Subsequent
    invocations of this method will return the cached value until it
    expires. If you set `refresh` parameter to `True`, the value will be
    refreshed and the expiration will be reset before being returned.
    &#34;&#34;&#34;
    with self._lock:
        if not refresh and not self.is_expired():
            return self.load()

        value = self._refresh_fn()
        self.save(value)
        LOG.info(&#34;refreshed data and saved in cache&#34;)
        return value</code></pre>
</details>
</dd>
<dt id="awsrun.cache.AbstractExpiringValue.is_expired"><code class="name flex">
<span>def <span class="ident">is_expired</span></span>(<span>self)</span>
</code></dt>
<dd>
<section class="desc"><p>Returns <code>True</code> if the value needs to be refreshed, <code>False</code> otherwise.</p>
<p>If this returns <code>True</code> during the invocation of
<code><a title="awsrun.cache.AbstractExpiringValue.value" href="#awsrun.cache.AbstractExpiringValue.value">AbstractExpiringValue.value()</a></code>, the <code>refresh_fn</code> will be called, followed
by <code>save</code>, to renew the cached value. When this returns <code>False</code>, <code>load</code>
is invoked instead to return the value from the cache.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_expired(self):
    &#34;&#34;&#34;Returns `True` if the value needs to be refreshed, `False` otherwise.

    If this returns `True` during the invocation of
    `AbstractExpiringValue.value`, the `refresh_fn` will be called, followed
    by `save`, to renew the cached value. When this returns `False`, `load`
    is invoked instead to return the value from the cache.
    &#34;&#34;&#34;
    raise NotImplementedError</code></pre>
</details>
</dd>
<dt id="awsrun.cache.AbstractExpiringValue.load"><code class="name flex">
<span>def <span class="ident">load</span></span>(<span>self)</span>
</code></dt>
<dd>
<section class="desc"><p>Returns the value from the cache.</p>
<p>If <code>is_expired</code> returns <code>False</code> during the invocation of
<code><a title="awsrun.cache.AbstractExpiringValue.value" href="#awsrun.cache.AbstractExpiringValue.value">AbstractExpiringValue.value()</a></code>, this method is invoked to return the
value from the cache.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load(self):
    &#34;&#34;&#34;Returns the value from the cache.

    If `is_expired` returns `False` during the invocation of
    `AbstractExpiringValue.value`, this method is invoked to return the
    value from the cache.
    &#34;&#34;&#34;
    raise NotImplementedError</code></pre>
</details>
</dd>
<dt id="awsrun.cache.AbstractExpiringValue.save"><code class="name flex">
<span>def <span class="ident">save</span></span>(<span>self, value)</span>
</code></dt>
<dd>
<section class="desc"><p>Saves the value to the cache.</p>
<p>If <code>is_expired</code> returns <code>True</code> during the invocation of
<code><a title="awsrun.cache.AbstractExpiringValue.value" href="#awsrun.cache.AbstractExpiringValue.value">AbstractExpiringValue.value()</a></code>, this method is invoked to save the new
value to the cache.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def save(self, value):
    &#34;&#34;&#34;Saves the value to the cache.

    If `is_expired` returns `True` during the invocation of
    `AbstractExpiringValue.value`, this method is invoked to save the new
    value to the cache.
    &#34;&#34;&#34;
    raise NotImplementedError</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="awsrun.cache.ExpiringValue"><code class="flex name class">
<span>class <span class="ident">ExpiringValue</span></span>
<span>(</span><span>refresh_fn, max_age)</span>
</code></dt>
<dd>
<section class="desc"><p>Represents a lazily loaded value that will expire over time.</p>
<p>An <code><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></code> represents a lazily loaded value that will expire over
time and is cached in memory. The constructor takes a <code>refresh_fn</code> function
of zero arguments, which is called to obtain the value to be cached for
<code>max_age</code> seconds.</p>
<p>At the time of instantiation, the value is not retrieved, it is only
retrieved the first time the value method is invoked. Likewise, the value is
not refreshed at the time it expires, but only the next time the value
method is called. This class is thread-safe.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ExpiringValue(AbstractExpiringValue):
    &#34;&#34;&#34;Represents a lazily loaded value that will expire over time.

    An `ExpiringValue` represents a lazily loaded value that will expire over
    time and is cached in memory. The constructor takes a `refresh_fn` function
    of zero arguments, which is called to obtain the value to be cached for
    `max_age` seconds.

    At the time of instantiation, the value is not retrieved, it is only
    retrieved the first time the value method is invoked. Likewise, the value is
    not refreshed at the time it expires, but only the next time the value
    method is called. This class is thread-safe.
    &#34;&#34;&#34;

    def __init__(self, refresh_fn, max_age):
        super().__init__(refresh_fn, max_age)
        self._value = None
        self._expiry = 0

    def is_expired(self):
        return time.time() &gt;= self._expiry

    def load(self):
        LOG.debug(&#34;Loading data from cache&#34;)
        return self._value

    def save(self, value):
        LOG.debug(&#34;Saving value to cache&#34;)
        self._value = value
        self._expiry = time.time() + self._max_age</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<code><li><a title="awsrun.cache.AbstractExpiringValue" href="#awsrun.cache.AbstractExpiringValue">AbstractExpiringValue</a></li></code>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<code><li><a title="awsrun.cache.PersistentExpiringValue" href="#awsrun.cache.PersistentExpiringValue">PersistentExpiringValue</a></li></code>
</ul>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="awsrun.cache.AbstractExpiringValue" href="#awsrun.cache.AbstractExpiringValue">AbstractExpiringValue</a></b></code>:
<ul class="hlist">
<li><code><a title="awsrun.cache.AbstractExpiringValue.is_expired" href="#awsrun.cache.AbstractExpiringValue.is_expired">is_expired</a></code></li>
<li><code><a title="awsrun.cache.AbstractExpiringValue.load" href="#awsrun.cache.AbstractExpiringValue.load">load</a></code></li>
<li><code><a title="awsrun.cache.AbstractExpiringValue.save" href="#awsrun.cache.AbstractExpiringValue.save">save</a></code></li>
<li><code><a title="awsrun.cache.AbstractExpiringValue.value" href="#awsrun.cache.AbstractExpiringValue.value">value</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="awsrun.cache.PersistentExpiringValue"><code class="flex name class">
<span>class <span class="ident">PersistentExpiringValue</span></span>
<span>(</span><span>refresh_fn, path, max_age)</span>
</code></dt>
<dd>
<section class="desc"><p>Represents an expiring value that will be persisted to disk as JSON.</p>
<p>A <code><a title="awsrun.cache.PersistentExpiringValue" href="#awsrun.cache.PersistentExpiringValue">PersistentExpiringValue</a></code> represents a lazily loaded value that will
expire over time and is cached to disk as JSON. The constructor takes a
<code>refresh_fn</code> function of zero arguments, which is called to obtain the value
to be cached for <code>max_age</code> seconds to the file specified by the <code>path</code> &ndash;
either a string or a <code>pathlib.Path</code> object.</p>
<p>At the time of instantiation, the value is not retrieved, it is only
retrieved the first time the value method is invoked. Likewise, the value is
not refreshed at the time it expires, but only the next time the value
method is called. This class is thread-safe. If the value cannot be
persisted as JSON, a TypeError is thrown.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class PersistentExpiringValue(ExpiringValue):
    &#34;&#34;&#34;Represents an expiring value that will be persisted to disk as JSON.

    A `PersistentExpiringValue` represents a lazily loaded value that will
    expire over time and is cached to disk as JSON. The constructor takes a
    `refresh_fn` function of zero arguments, which is called to obtain the value
    to be cached for `max_age` seconds to the file specified by the `path` --
    either a string or a `pathlib.Path` object.

    At the time of instantiation, the value is not retrieved, it is only
    retrieved the first time the value method is invoked. Likewise, the value is
    not refreshed at the time it expires, but only the next time the value
    method is called. This class is thread-safe. If the value cannot be
    persisted as JSON, a TypeError is thrown.
    &#34;&#34;&#34;

    def __init__(self, refresh_fn, path, max_age):
        super().__init__(refresh_fn, max_age)
        self._path = path if isinstance(path, Path) else Path(path)

    def is_expired(self):
        if not self._path.exists():
            return True
        last_modification = self._path.stat().st_mtime
        return time.time() &gt; last_modification + self._max_age

    def load(self):
        LOG.debug(&#34;Loading cached data from %s&#34;, self._path)
        with self._path.open(&#34;r&#34;, encoding=&#34;utf-8&#34;) as file:
            return json.load(file)

    def save(self, value):
        # No need to persist the file if max_age is 0 seconds.
        if self._max_age == 0:
            return

        LOG.debug(&#34;Saving data to cache file %s&#34;, self._path)
        tmp = self._path.with_suffix(&#34;.tmp&#34;)
        with tmp.open(&#34;w&#34;, encoding=&#34;utf-8&#34;) as file:
            json.dump(value, file)

        # Pathlib.replace uses os.replace which is atomic on POSIX systems
        tmp.replace(self._path)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<code><li><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></li></code>
<code><li><a title="awsrun.cache.AbstractExpiringValue" href="#awsrun.cache.AbstractExpiringValue">AbstractExpiringValue</a></li></code>
</ul>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></b></code>:
<ul class="hlist">
<li><code><a title="awsrun.cache.ExpiringValue.is_expired" href="#awsrun.cache.AbstractExpiringValue.is_expired">is_expired</a></code></li>
<li><code><a title="awsrun.cache.ExpiringValue.load" href="#awsrun.cache.AbstractExpiringValue.load">load</a></code></li>
<li><code><a title="awsrun.cache.ExpiringValue.save" href="#awsrun.cache.AbstractExpiringValue.save">save</a></code></li>
<li><code><a title="awsrun.cache.ExpiringValue.value" href="#awsrun.cache.AbstractExpiringValue.value">value</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
</ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="awsrun" href="index.html">awsrun</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="awsrun.cache.AbstractExpiringValue" href="#awsrun.cache.AbstractExpiringValue">AbstractExpiringValue</a></code></h4>
<ul class="">
<li><code><a title="awsrun.cache.AbstractExpiringValue.value" href="#awsrun.cache.AbstractExpiringValue.value">value</a></code></li>
<li><code><a title="awsrun.cache.AbstractExpiringValue.is_expired" href="#awsrun.cache.AbstractExpiringValue.is_expired">is_expired</a></code></li>
<li><code><a title="awsrun.cache.AbstractExpiringValue.load" href="#awsrun.cache.AbstractExpiringValue.load">load</a></code></li>
<li><code><a title="awsrun.cache.AbstractExpiringValue.save" href="#awsrun.cache.AbstractExpiringValue.save">save</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="awsrun.cache.ExpiringValue" href="#awsrun.cache.ExpiringValue">ExpiringValue</a></code></h4>
</li>
<li>
<h4><code><a title="awsrun.cache.PersistentExpiringValue" href="#awsrun.cache.PersistentExpiringValue">PersistentExpiringValue</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>